// public read-only indexer database access provided by near foundation
// TESTNET_DB_URL="postgresql://public_readonly:nearprotocol@35.184.214.98:5432/testnet_explorer"
// MAINNET_DB_URL="postgresql://public_readonly:nearprotocol@104.199.89.51:5432/mainnet_explorer

datasource db {
  provider = "postgresql"
  url      = env("MAINNET_DB_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum AccessKeyPermissionKind {
  @@map("access_key_permission_kinds")
  FULL_ACCESS
  FUNCTION_CALL
}

enum ActionKind {
  @@map("action_kind")
  CREATE_ACCOUNT
  DEPLOY_CONTRACT
  FUNCTION_CALL
  TRANSFER
  STAKE
  ADD_KEY
  DELETE_KEY
  DELETE_ACCOUNT
}

enum ExecutionOutcomeStatus {
  @@map("execution_outcome_status")
  UNKNOWN
  FAILURE
  SUCCESS_VALUE
  SUCCESS_RECEIPT_ID
}


enum ReceiptKind {
  @@map("receipt_kind")
  ACTION
  DATA
}


enum StateChangeReasonKind {
  @@map("state_change_reason_kind")
  TRANSACTION_PROCESSING
  ACTION_RECEIPT_PROCESSING_STARTED
  ACTION_RECEIPT_GAS_REWARD
  RECEIPT_PROCESSING
  POSTPONED_RECEIPT
  UPDATED_DELAYED_RECEIPTS
  VALIDATOR_ACCOUNTS_UPDATE
}

model AccessKey {
  @@map("access_keys")
  @@id([publicKey, accountId])
  @@index([accountId, lastUpdateBlockHeight])

  publicKey String @map("public_key")
  account Account @relation(fields: [accountId], references: accountId)
  accountId String @map("account_id")
  createdByReceipt Receipt? @relation("AccessKeyCreated", fields:[createdByReceiptId], references: [receiptId]) 
  createdByReceiptId String? @map("created_by_receipt_id")
  deletedByReceipt Receipt? @relation("AccessKeyDeleted", fields:[deletedByReceiptId], references: [receiptId]) 
  deletedByReceiptId String?  @map("deleted_by_receipt_id")
  permissionKind AccessKeyPermissionKind @map("permission_kind")
  lastUpdateBlockHeight Decimal @db.Decimal(20, 0) @map("last_update_block_height")
}

model AccountChange {
  @@map("account_changes")
  @@unique([affectedAccountId, changedInBlockHash,causedByTransactionHash, causedByReceiptId])
  @@index([affectedAccountId, changedInBlockHash, changedInBlockTimestamp,causedByReceiptId,causedByTransactionHash])

  id BigInt @db.BigInt @default(autoincrement()) @id @map("id")
  affectedAccount Account @relation(fields: [affectedAccountId], references:accountId) 
  affectedAccountId String @map("affected_account_id")
  changedInBlockTimestamp Decimal @db.Decimal(20,0) @map("changed_in_block_timestamp")
  changedInBlock Blocks @relation(fields: [changedInBlockHash], references:[blockHash]) 
  changedInBlockHash String @map("changed_in_block_hash")
  causedByTransaction Transaction? @relation(fields: [causedByTransactionHash], references: [transactionHash]) 
  causedByTransactionHash String? @map("caused_by_transaction_hash")
  causedByReceipt Receipt? @relation(fields: [causedByReceiptId], references: receiptId) 
  causedByReceiptId String? @map("caused_by_receipt_id")
  updateReason StateChangeReasonKind @map("update_reason")
  affectedAccountNonstakedBalance Decimal @db.Decimal(45,0) @map("affected_account_nonstaked_balance")
  affectedAccountStakedBalance Decimal @db.Decimal(45,0) @map("affected_account_staked_balance")
  affectedAccountStorageUsage Decimal @db.Decimal(20,0) @map("affected_account_storage_usage")
}

model Account {
  @@map("accounts")
  @@index([lastUpdateBlockHeight])
  id BigInt @db.BigInt  @default(autoincrement()) @id @map("id")
  accountId String @db.Text @unique @map("account_id")
  createdByReceipt Receipt? @relation("AccountCreated", fields: [createdByReceiptId], references:[receiptId]) 
  createdByReceiptId String? @map("created_by_receipt_id")
  deletedByReceipt Receipt? @relation("AccountDeleted", fields:[deletedByReceiptId], references:[receiptId]) 
  deletedByReceiptId String? @map("deleted_by_receipt_id")
  lastUpdateBlockHeight Decimal @db.Decimal(20,0)  @map("last_update_block_height")

  accessKeys AccessKey[]
  accountChanges AccountChange[] 
  signedActionReceipts ActionReceipt[] @relation("SignerAccount") 
  signedTransactions Transaction[] 
  receiptsAsPredecessor Receipt[] @relation("PredecessorAccount") 
  receiptsAsReceiver Receipt[] @relation("ReceiverAccount") 
  authoredBlocks Blocks[] 
  authoredChunks Chunk[] 
  executionOutcomes ExecutionOutcome[] 
}

model ActionReceiptAction {
  @@map("action_receipt_actions")
  @@id([receiptId, indexInActionReceipt])
  receipt ActionReceipt @relation(fields: [receiptId], references: receiptId) 
  receiptId String @map("receipt_id")
  indexInActionReceipt Int @map("index_in_action_receipt")
  actionKind ActionKind @map("action_kind")
  args Json @db.JsonB @map("args")
}

model ActionReceiptInputData {
  @@map("action_receipt_input_data")
  @@id([inputDataId, inputToReceiptId])
  @@index([inputDataId, inputToReceiptId])

  inputDataId String @map("input_data_id")
  inputToReceiptId String @map("input_to_receipt_id")
}

model ActionReceiptOutputData {
  @@map("action_receipt_output_data")
  @@id([outputDataId, outputToReceiptId])
  @@index([outputToReceiptId, receiverAccountId])

  outputDataId String @map("output_data_id")
  outputToReceipt ActionReceipt @relation(fields: [outputToReceiptId], references:[receiptId]) 
  outputToReceiptId String @map("output_to_receipt_id")
  // receiverAccount Account @relation("ReceiverAccount", fields: [receiverAccountId],
  receiverAccountId String @map("receiver_account_id")
}

model ActionReceipt {
  @@map("action_receipts")
  @@index([signerAccountId])
  receiptId String @id @map("receipt_id")
  signerAccount Account @relation("SignerAccount", fields: [signerAccountId], references: [accountId]) 
  signerAccountId String @map("signer_account_id")
  signerPublicKey String @map("signer_public_key")
  gasPrice Decimal @db.Decimal(45,0) @map("gas_price")

  actions ActionReceiptAction[] 
  outputData ActionReceiptOutputData[] 
}

model Blocks {
  @@map("blocks")
  @@index([blockHeight, blockHash, blockTimestamp])
  blockHash String @id @map("block_hash")
  blockHeight Decimal @db.Decimal(20,0) @map("block_height")
  prevBlock Blocks @relation("PreviousBlock", fields: [prevBlockHash], references:blockHash) 
  prevBlockHash String @map("prev_block_hash")
  blockTimestamp Decimal @db.Decimal(20,0) @map("block_timestamp")
  totalSupply Decimal @db.Decimal(45,0) @map("total_supply")
  gasPrice Decimal @db.Decimal(45,0) @map("gas_price")
  authorAccount Account @relation(fields: [authorAccountId], references:[accountId]) 
  authorAccountId String  @map("author_account_id")

  accountChanges AccountChange[]
  chunks Chunk[] 
  transactions Transaction[] 
  receipts Receipt[] 
  executionOutcomes ExecutionOutcome[] 
  nextBlock Blocks? @relation("PreviousBlock") 
}


model Chunk {
  @@map("chunks")
  @@index([includedInBlockHash])
  chunkHash String @id @map("chunk_hash")
  includedInBlock Blocks @relation(fields: [includedInBlockHash], references:[blockHash]) 
  includedInBlockHash String @map("included_in_block_hash")
  shardId Decimal @db.Decimal(20,0) @map("shard_id")
  signature String @map("signature")
  gasLimit Decimal @db.Decimal(20,0) @map("gas_limit")
  gasUsed Decimal @db.Decimal(20,0) @map("gas_used")
  authorAccount Account @relation(fields: [authorAccountId], references:[accountId]) 
  authorAccountId String @map("author_account_id")

  transactions Transaction[] 
  receipts Receipt[] 
  executionOutcomes ExecutionOutcome[] 
}


model DataReceipt {
  @@map("data_receipts")
  @@index([receiptId])
  dataId String @id @map("data_id")
  receiptId String  @map("receipt_id")
  data Bytes? @db.ByteA @map("data")
}

model ExecutionOutcomeReceipt {
  @@map("execution_outcome_receipts")
  @@id([executedReceiptId, indexInExecutionOutcome, producedReceiptId])
  @@index([producedReceiptId])
  
  executedReceiptId String  @map("executed_receipt_id")
  indexInExecutionOutcome Int @map("index_in_execution_outcome")
  producedReceiptId String  @map("produced_receipt_id")
}

model ExecutionOutcome {
  @@map("execution_outcomes")
  @@index([executedInBlockHash,receiptId])

  receiptId String @id @map("receipt_id")
  executedInBlock Blocks @relation(fields:[executedInBlockHash], references: [blockHash]) 
  executedInBlockHash String  @map("executed_in_block_hash")
  executedInBlockTimestamp Decimal @db.Decimal(20,0)  @map("executed_in_block_timestamp")
  executedInChunk Chunk @relation(fields:[executedInChunkHash], references: [chunkHash]) 
  executedInChunkHash String @db.Text @map("executed_in_chunk_hash")
  indexInChunk Int  @map("index_in_chunk")
  gasBurnt Decimal @db.Decimal(20,0)  @map("gas_burnt")
  tokensBurnt Decimal @db.Decimal(45,0) @map("tokens_burnt")
  executorAccount Account @relation(fields: [executorAccountId], references:[accountId]) 
  executorAccountId String  @map("executor_account_id")
  status ExecutionOutcomeStatus @map("status")
}


model Receipt {
  @@map("receipts")
  @@index([includedInBlockHash,includedInBlockTimestamp,includedInChunkHash,predecessorAccountId,receiptId])
  receiptId String @id @map("receipt_id")
  includedInBlock Blocks @relation(fields:[includedInBlockHash], references: [blockHash]) 
  includedInBlockHash String  @map("included_in_block_hash")
  includedInChunk Chunk @relation(fields:[includedInChunkHash], references: [chunkHash]) 
  includedInChunkHash String @map("included_in_chunk_hash")
  indexInChunk Int @map("index_in_chunk")
  includedInBlockTimestamp Decimal @db.Decimal(20,0) @map("included_in_block_timestamp")
  
  predecessorAccount Account @relation("PredecessorAccount",fields: [predecessorAccountId], references: [accountId]) 
  predecessorAccountId String @map("predecessor_account_id")

  receiverAccount Account @relation("ReceiverAccount", fields: [receiverAccountId], references:[accountId]) 
  receiverAccountId String @map("receiver_account_id")
  
  receiptKind ReceiptKind @map("receipt_kind")

  originatedFromTransaction Transaction @relation(fields:[originatedFromTransactionHash], references: [transactionHash]) 
  originatedFromTransactionHash String @map("originated_from_transaction_hash")


  accountsCreated Account[] @relation("AccountCreated") 
  accountsDeleted Account[] @relation("AccountDeleted") 
  accessKeysCreated AccessKey[] @relation("AccessKeyCreated") 
  accessKeysDeleted AccessKey[] @relation("AccessKeyDeleted") 
  accountChanges AccountChange[] 

}

model Transaction {
  @@map("transactions")
  @@index([convertedIntoReceiptId, includedInBlockHash,includedInChunkHash, blockTimestamp,signerAccountId, signerPublicKey])
  transactionHash String @id @map("transaction_hash")
  includedInBlock Blocks @relation(fields: [includedInBlockHash], references: blockHash) 
  includedInBlockHash String @map("included_in_block_hash")
  includedInChunk Chunk @relation(fields: [includedInChunkHash], references: chunkHash) 
  includedInChunkHash String @map("included_in_chunk_hash")
  indexInChunk Int @map("index_in_chunk")
  blockTimestamp Decimal @db.Decimal(20,0) @map("block_timestamp")
  signerAccount Account @relation(fields: [signerAccountId], references:[accountId]) 
  signerAccountId String  @map("signer_account_id")
  signerPublicKey String  @map("signer_public_key")
  nonce Decimal @db.Decimal(20,0) @map("nonce")
  // receiverAccount Account
  receiverAccountId String @map("receiver_account_id")
  signature String @map("signature")
  // status public.executionOutcomeStatus 
  convertedIntoReceiptId String @map("converted_into_receipt_id")
  receiptConversionGasBurnt Decimal? @db.Decimal(20,0) @map("receipt_conversion_gas_burnt")
  receiptConversionTokensBurnt Decimal? @db.Decimal(45,0) @map("receipt_conversion_tokens_burnt")

  accountChanges AccountChange[] 
  receipts Receipt[] 
}

model TransactionAction {
  @@map("transaction_actions")
  @@id([transactionHash, indexInTransaction])

  transactionHash String  @map("transaction_hash")
  indexInTransaction Int @map("index_in_transaction")
  actionKind ActionKind @map("action_kind")
  args Json @db.JsonB @map("args")

}
